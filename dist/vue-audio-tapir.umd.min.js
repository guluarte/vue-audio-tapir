(function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e(require("vue")):"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["vue-audio-tapir"]=e(require("vue")):t["vue-audio-tapir"]=e(t["Vue"])})("undefined"!==typeof self?self:this,(function(t){return function(){"use strict";var e={744:function(t,e){e.Z=(t,e)=>{const s=t.__vccOpts||t;for(const[i,o]of e)s[i]=o;return s}},203:function(e){e.exports=t}},s={};function i(t){var o=s[t];if(void 0!==o)return o.exports;var r=s[t]={exports:{}};return e[t](r,r.exports,i),r.exports}!function(){i.d=function(t,e){for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})}}(),function(){i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){i.p=""}();var o={};return function(){if(i.d(o,{default:function(){return B}}),"undefined"!==typeof window){var t=window.document.currentScript,e=t&&t.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);e&&(i.p=e[1])}var s=i(203);const r={class:"text-center font-sans w-96 mx-auto"},n={class:"text-sm text-red-400"};function a(t,e,i,o,a,c){const l=(0,s.resolveComponent)("icon-button");return(0,s.openBlock)(),(0,s.createElementBlock)("div",r,[(0,s.createElementVNode)("div",null,[a.recording?((0,s.openBlock)(),(0,s.createBlock)(l,{key:0,style:(0,s.normalizeStyle)({"border-color":i.buttonColor}),class:(0,s.normalizeClass)(c.buttonClass),name:"stop",onClick:c.toggleRecording},null,8,["style","class","onClick"])):((0,s.openBlock)(),(0,s.createBlock)(l,{key:1,style:(0,s.normalizeStyle)({"border-color":i.buttonColor}),class:(0,s.normalizeClass)(c.buttonClass),name:"mic",onClick:c.toggleRecording},null,8,["style","class","onClick"]))]),(0,s.createElementVNode)("div",n,(0,s.toDisplayString)(a.errorMessage),1)])}class c{constructor(t){this.backendEndpoint=t}async postBackend(t){try{const e=await fetch(this.backendEndpoint,{method:"POST",body:t});return!!e.ok}catch(e){return!1}}}var l=class{constructor(t){this.bufferSize=t.bufferSize||4096,this.sampleRate=t.sampleRate,this.samples=t.samples}finish(){this._joinSamples();const t=new ArrayBuffer(44+2*this.samples.length),e=new DataView(t);this._writeString(e,0,"RIFF"),e.setUint32(4,36+2*this.samples.length,!0),this._writeString(e,8,"WAVE"),this._writeString(e,12,"fmt "),e.setUint32(16,16,!0),e.setUint16(20,1,!0),e.setUint16(22,1,!0),e.setUint32(24,this.sampleRate,!0),e.setUint32(28,4*this.sampleRate,!0),e.setUint16(32,4,!0),e.setUint16(34,16,!0),this._writeString(e,36,"data"),e.setUint32(40,2*this.samples.length,!0),this._floatTo16BitPCM(e,44,this.samples);const s=new Blob([e],{type:"audio/wav"});return{id:Date.now(),blob:s,url:URL.createObjectURL(s)}}_floatTo16BitPCM(t,e,s){for(let i=0;i<s.length;i++,e+=2){const o=Math.max(-1,Math.min(1,s[i]));t.setInt16(e,o<0?32768*o:32767*o,!0)}}_joinSamples(){const t=this.samples.length*this.bufferSize,e=new Float64Array(t);let s=0;for(let i=0;i<this.samples.length;i++){const t=this.samples[i];e.set(t,s),s+=t.length}this.samples=e}_writeString(t,e,s){for(let i=0;i<s.length;i++)t.setUint8(e+i,s.charCodeAt(i))}};function d(t){return t?new Date(1e3*t).toISOString().substr(14,5):null}class h{constructor(t={}){this.beforeRecording=t.beforeRecording,this.pauseRecording=t.pauseRecording,this.afterRecording=t.afterRecording,this.micFailed=t.micFailed,this.encoderOptions={bitRate:t.bitRate,sampleRate:t.sampleRate},this.bufferSize=4096,this.records=[],this.isPause=!1,this.isRecording=!1,this.duration=0,this.volume=0,this.wavSamples=[],this._duration=0}start(){const t={video:!1,audio:{channelCount:1,echoCancellation:!1}};this.beforeRecording&&this.beforeRecording("start recording"),navigator.mediaDevices.getUserMedia(t).then(this._micCaptured.bind(this)).catch(this._micError.bind(this)),this.isPause=!1,this.isRecording=!0}stop(){this.stream.getTracks().forEach((t=>t.stop())),this.input.disconnect(),this.processor.disconnect(),this.context.close();let t=null;const e=new l({bufferSize:this.bufferSize,sampleRate:this.encoderOptions.sampleRate,samples:this.wavSamples});t=e.finish(),this.wavSamples=[],t.duration=d(this.duration),this.records.push(t),this._duration=0,this.duration=0,this.isPause=!1,this.isRecording=!1,this.afterRecording&&this.afterRecording(t)}pause(){this.stream.getTracks().forEach((t=>t.stop())),this.input.disconnect(),this.processor.disconnect(),this._duration=this.duration,this.isPause=!0,this.pauseRecording&&this.pauseRecording("pause recording")}recordList(){return this.records}lastRecord(){return this.records.slice(-1).pop()}_micCaptured(t){this.context=new(window.AudioContext||window.webkitAudioContext),this.duration=this._duration,this.input=this.context.createMediaStreamSource(t),this.processor=this.context.createScriptProcessor(this.bufferSize,1,1),this.stream=t,this.processor.onaudioprocess=t=>{const e=t.inputBuffer.getChannelData(0);let s=0;this.wavSamples.push(new Float32Array(e));for(let i=0;i<e.length;++i)s+=e[i]*e[i];this.duration=parseFloat(this._duration)+parseFloat(this.context.currentTime.toFixed(2)),this.volume=Math.sqrt(s/e.length).toFixed(2)},this.input.connect(this.processor),this.processor.connect(this.context.destination)}_micError(t){this.micFailed&&this.micFailed(t)}}const u=["innerHTML"];function p(t,e,i,o,r,n){return(0,s.openBlock)(),(0,s.createElementBlock)("div",{innerHTML:r.icons[i.name]},null,8,u)}var g={props:{name:{type:String}},data(){return{icons:{download:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/><path fill="none" d="M0 0h24v24H0z"/></svg>',mic:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',play:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',save:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>',stop:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 6h12v12H6z"/></svg>',volume:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'}}}},m=i(744);const f=(0,m.Z)(g,[["render",p]]);var v=f;const w="Click icon to start recording message.",b="Click icon again to stop recording.",R="Failed to use microphone. Please refresh and try again and permit the use of a microphone.",y="Successfully recorded message!",x="Successfully submitted audio message! Thank you!",M="Error submitting audio message! Please try again later.";var S={name:"TapirWidget",props:{time:{type:Number,default:1},bitRate:{type:Number,default:128},sampleRate:{type:Number,default:44100},backendEndpoint:{type:String},buttonColor:{type:String,default:"green"},afterRecording:{type:Function},successfulUpload:{type:Function},failedUpload:{type:Function},customUpload:{type:Function,default:null}},components:{IconButton:v},data(){return{recording:!1,recordedAudio:null,recordedBlob:null,recorder:null,successMessage:null,errorMessage:null,instructionMessage:w}},computed:{buttonClass(){return"mx-auto h-14 w-14 fill-current text-black cursor-pointer rounded-50 border-2 m-4 p-2"},recordedTime(){return this.time&&this.recorder?.duration>=60*this.time&&this.toggleRecording(),d(this.recorder?.duration)}},beforeUnmount(){this.recording&&this.stopRecorder()},methods:{toggleRecording(){this.recording=!this.recording,this.recording?this.initRecorder():this.stopRecording()},initRecorder(){this.recorder=new h({micFailed:this.micFailed,bitRate:this.bitRate,sampleRate:this.sampleRate}),this.recorder.start(),this.successMessage=null,this.errorMessage=null,this.instructionMessage=b,this.service=new c(this.backendEndpoint)},stopRecording(){this.recorder.stop();const t=this.recorder.recordList();this.recordedAudio=t[0].url,this.recordedBlob=t[0].blob,this.recordedAudio&&(this.successMessage=y,this.instructionMessage=null),this.afterRecording&&this.sendData()},async sendData(){if(!this.recordedBlob)return;let t=null;t=this.customUpload?await this.customUpload(this.recordedBlob):await this.service.postBackend(this.recordedBlob),t?(this.errorMessage=null,this.successMessage=x,this.successfulUpload&&this.successfulUpload()):(this.successMessage=null,this.errorMessage=M,this.failedUpload&&this.failedUpload())},micFailed(){this.recording=!1,this.instructionMessage=w,this.errorMessage=R}}};const z=(0,m.Z)(S,[["render",a]]);var k=z,B=k}(),o=o["default"],o}()}));
//# sourceMappingURL=vue-audio-tapir.umd.min.js.map